name: Update Lucide Icons

on:
  schedule:
    - cron: '0 9 * * 1'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update:
    name: Check for Lucide updates
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'

    - name: Check for updates and update if available
      id: update
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Run the update tool and capture JSON output
        go run cmd/tool/main.go update > result.json 2>&1 || true

        # Parse the JSON result
        if [ -f result.json ]; then
          cat result.json

          HAS_UPDATES=$(jq -r '.has_updates' result.json)
          CURRENT_TAG=$(jq -r '.current_tag' result.json)
          NEW_TAG=$(jq -r '.latest_tag' result.json)
          ICONS_ADDED=$(jq -r '.icons_added' result.json)
          ICONS_REMOVED=$(jq -r '.icons_removed' result.json)
          RELEASE_NOTES=$(jq -r '.release_notes' result.json)

          echo "has_updates=$HAS_UPDATES" >> $GITHUB_OUTPUT
          echo "current_version=$CURRENT_TAG" >> $GITHUB_OUTPUT
          echo "new_version=$NEW_TAG" >> $GITHUB_OUTPUT
          echo "icons_added=$ICONS_ADDED" >> $GITHUB_OUTPUT
          echo "icons_removed=$ICONS_REMOVED" >> $GITHUB_OUTPUT

          # Store release notes in a file for multiline handling
          echo "$RELEASE_NOTES" > release_notes.txt
        else
          echo "has_updates=false" >> $GITHUB_OUTPUT
        fi

    - name: Create Pull Request
      if: steps.update.outputs.has_updates == 'true'
      uses: peter-evans/create-pull-request@v7
      with:
        commit-message: |
          chore: update lucide icons to ${{ steps.update.outputs.new_version }}

          - Updated from ${{ steps.update.outputs.current_version }} to ${{ steps.update.outputs.new_version }}
          - Regenerated icon functions
          - Updated CHANGELOG.md
          - Updated .lucide-version
        branch: update-lucide-icons
        delete-branch: true
        title: 'chore: Update lucide icons to ${{ steps.update.outputs.new_version }}'
        body: |
          ## ðŸŽ¨ Lucide Icons Update

          This PR updates the Lucide icons and regenerates the icon functions.

          ### Changes
          - **Previous version:** `${{ steps.update.outputs.current_version }}`
          - **New version:** `${{ steps.update.outputs.new_version }}`
          - **Icons added:** ${{ steps.update.outputs.icons_added }}
          - **Icons removed:** ${{ steps.update.outputs.icons_removed }}

          ### Upstream Changes
          See the full changelog at: https://github.com/lucide-icons/lucide/releases/tag/${{ steps.update.outputs.new_version }}

          ### Files Updated
          - `lucide-icons/` (downloaded from release)
          - `icons.go` (regenerated)
          - `CHANGELOG.md`
          - `.lucide-version`

          ---

          ðŸ¤– This PR was automatically generated
        labels: |
          dependencies
          automated
